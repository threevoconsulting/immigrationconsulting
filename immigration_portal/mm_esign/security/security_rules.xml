<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        
        <!-- =========================== -->
        <!-- E-Sign Request Record Rules -->
        <!-- =========================== -->
        
        <!-- Portal users can read their own esign requests -->
        <record id="esign_request_portal_read_rule" model="ir.rule">
            <field name="name">E-Sign Request: Portal Read Own</field>
            <field name="model_id" ref="model_mm_esign_request"/>
            <field name="domain_force">[('partner_id', '=', user.partner_id.id)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
        <!-- Portal users can write to their own pending signature requests -->
        <record id="esign_request_portal_sign_rule" model="ir.rule">
            <field name="name">E-Sign Request: Portal Can Sign Own</field>
            <field name="model_id" ref="model_mm_esign_request"/>
            <field name="domain_force">[
                ('partner_id', '=', user.partner_id.id),
                ('state', 'in', ('sent', 'viewed'))
            ]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        
        <!-- Immigration users see their company's requests -->
        <record id="esign_request_user_rule" model="ir.rule">
            <field name="name">E-Sign Request: User Company Access</field>
            <field name="model_id" ref="model_mm_esign_request"/>
            <field name="domain_force">[('company_id', 'in', company_ids)]</field>
            <field name="groups" eval="[(4, ref('mm_immigration.group_immigration_user'))]"/>
        </record>
        
        <!-- Consultants see assigned cases' esign requests -->
        <record id="esign_request_consultant_rule" model="ir.rule">
            <field name="name">E-Sign Request: Consultant Access Assigned</field>
            <field name="model_id" ref="model_mm_esign_request"/>
            <field name="domain_force">[
                '|',
                ('case_id.consultant_id', '=', user.id),
                ('case_id.consultant_id', '=', False)
            ]</field>
            <field name="groups" eval="[(4, ref('mm_immigration.group_immigration_consultant'))]"/>
        </record>
        
        <!-- Managers see all in their company -->
        <record id="esign_request_manager_rule" model="ir.rule">
            <field name="name">E-Sign Request: Manager Full Access</field>
            <field name="model_id" ref="model_mm_esign_request"/>
            <field name="domain_force">[('company_id', 'in', company_ids)]</field>
            <field name="groups" eval="[(4, ref('mm_immigration.group_immigration_manager'))]"/>
        </record>
        
    </data>
</odoo>
