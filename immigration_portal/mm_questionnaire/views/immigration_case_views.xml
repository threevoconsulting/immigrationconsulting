<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- ===================== -->
    <!-- Immigration Case View Extensions -->
    <!-- ===================== -->

    <!-- Extend the case form with questionnaire information -->
    <record id="view_immigration_case_form_questionnaire" model="ir.ui.view">
        <field name="name">mm.immigration.case.form.questionnaire</field>
        <field name="model">mm.immigration.case</field>
        <field name="inherit_id" ref="mm_immigration.view_immigration_case_form"/>
        <field name="arch" type="xml">
            <!-- Add questionnaire buttons to button box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_q1" type="object" class="oe_stat_button" icon="fa-clipboard" invisible="not pre_consultation_id">
                    <div class="o_stat_info">
                        <field name="q1_progress" widget="progressbar" class="mb-1"/>
                        <span class="o_stat_text">Pre-Consultation</span>
                    </div>
                </button>
                <button name="action_view_q2" type="object" class="oe_stat_button" icon="fa-file-text" invisible="not detailed_assessment_id">
                    <div class="o_stat_info">
                        <field name="q2_progress" widget="progressbar" class="mb-1"/>
                        <span class="o_stat_text">Assessment</span>
                    </div>
                </button>
            </xpath>

            <!-- Add questionnaire status page -->
            <xpath expr="//notebook" position="inside">
                <page string="Questionnaires" name="questionnaires">
                    <group>
                        <group string="Pre-Consultation (Q1)">
                            <field name="q1_state" widget="badge" decoration-muted="q1_state == 'not_started'" decoration-warning="q1_state == 'in_progress'" decoration-success="q1_state == 'completed'"/>
                            <field name="q1_progress" widget="progressbar"/>
                            <field name="pre_consultation_id" readonly="1"/>
                        </group>
                        <group string="Detailed Assessment (Q2)">
                            <field name="q2_state" widget="badge" decoration-muted="q2_state == 'not_started'" decoration-warning="q2_state == 'in_progress'" decoration-success="q2_state == 'completed'"/>
                            <field name="q2_progress" widget="progressbar"/>
                            <field name="detailed_assessment_id" readonly="1"/>
                        </group>
                    </group>
                    <field name="questionnaire_response_ids" readonly="1">
                        <list>
                            <field name="questionnaire_type"/>
                            <field name="state" widget="badge" decoration-muted="state == 'not_started'" decoration-warning="state == 'in_progress'" decoration-success="state == 'completed'"/>
                            <field name="progress_percent" widget="progressbar"/>
                            <field name="started_at"/>
                            <field name="completed_at"/>
                        </list>
                    </field>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Extend case list view with questionnaire status -->
    <record id="view_immigration_case_list_questionnaire" model="ir.ui.view">
        <field name="name">mm.immigration.case.list.questionnaire</field>
        <field name="model">mm.immigration.case</field>
        <field name="inherit_id" ref="mm_immigration.view_immigration_case_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='stage_id']" position="after">
                <field name="q1_state" string="Q1" widget="badge" optional="show" decoration-muted="q1_state == 'not_started'" decoration-warning="q1_state == 'in_progress'" decoration-success="q1_state == 'completed'"/>
                <field name="q2_state" string="Q2" widget="badge" optional="show" decoration-muted="q2_state == 'not_started'" decoration-warning="q2_state == 'in_progress'" decoration-success="q2_state == 'completed'"/>
            </xpath>
        </field>
    </record>

    <!-- Add questionnaire filters to case search -->
    <record id="view_immigration_case_search_questionnaire" model="ir.ui.view">
        <field name="name">mm.immigration.case.search.questionnaire</field>
        <field name="model">mm.immigration.case</field>
        <field name="inherit_id" ref="mm_immigration.view_immigration_case_search"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <separator/>
                <filter name="filter_q1_pending" string="Q1 Pending" domain="[('q1_state', '!=', 'completed')]"/>
                <filter name="filter_q1_complete" string="Q1 Complete" domain="[('q1_state', '=', 'completed')]"/>
                <filter name="filter_q2_pending" string="Q2 Pending" domain="[('q2_state', '!=', 'completed')]"/>
                <filter name="filter_q2_complete" string="Q2 Complete" domain="[('q2_state', '=', 'completed')]"/>
            </xpath>
        </field>
    </record>

</odoo>
