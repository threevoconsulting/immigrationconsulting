<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Add Immigration to Portal Menu -->
    <template id="portal_my_home_immigration" name="Show Immigration Cases" 
              inherit_id="portal.portal_my_home" priority="30">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/mm_portal/static/src/img/immigration.svg'"/>
                <t t-set="title">Immigration Cases</t>
                <t t-set="url" t-value="'/my/immigration'"/>
                <t t-set="text">View your immigration cases and track progress</t>
                <t t-set="placeholder_count" t-value="'immigration_count'"/>
            </t>
        </xpath>
    </template>

    <!-- Progress Tracker Component -->
    <template id="portal_progress_tracker" name="Immigration Progress Tracker">
        <div class="immigration-progress-tracker mb-4">
            <div class="progress-stages d-flex justify-content-between position-relative">
                <!-- Progress Line Background -->
                <div class="progress-line position-absolute" 
                     style="top: 20px; left: 5%; right: 5%; height: 4px; background: #e9ecef; z-index: 0;">
                </div>
                <!-- Progress Line Fill -->
                <div class="progress-line-fill position-absolute" 
                     style="top: 20px; left: 5%; height: 4px; background: #875A7B; z-index: 1;"
                     t-attf-style="width: #{(current_position - 1) * (90 / (total_stages - 1)) if total_stages > 1 else 0}%;">
                </div>
                
                <!-- Stage Indicators -->
                <t t-foreach="stages" t-as="stage">
                    <div class="stage-item text-center position-relative" style="z-index: 2; flex: 1;">
                        <t t-set="is_complete" t-value="stage.sequence &lt; case.stage_id.sequence"/>
                        <t t-set="is_current" t-value="stage.id == case.stage_id.id"/>
                        <t t-set="is_future" t-value="stage.sequence &gt; case.stage_id.sequence"/>
                        
                        <div t-attf-class="stage-circle mx-auto mb-2 rounded-circle d-flex align-items-center justify-content-center #{is_complete and 'bg-success text-white' or (is_current and 'bg-primary text-white' or 'bg-light text-muted')}"
                             style="width: 40px; height: 40px; border: 3px solid;">
                            <t t-if="is_complete">
                                <i class="fa fa-check" aria-hidden="true"></i>
                            </t>
                            <t t-elif="is_current">
                                <span t-esc="stage_index + 1"/>
                            </t>
                            <t t-else="">
                                <span t-esc="stage_index + 1"/>
                            </t>
                        </div>
                        <small t-attf-class="stage-label d-block #{is_current and 'fw-bold text-primary' or (is_future and 'text-muted' or 'text-success')}">
                            <t t-esc="stage.name"/>
                        </small>
                    </div>
                </t>
            </div>
        </div>
    </template>

    <!-- Main Dashboard Template -->
    <template id="portal_immigration_dashboard" name="Immigration Dashboard">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Immigration Cases</t>
            </t>

            <div class="immigration-dashboard">
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h4 class="alert-heading">
                                <i class="fa fa-globe me-2" aria-hidden="true"></i>
                                Welcome to <t t-esc="settings.get('portal_name', 'Immigration Portal')"/>
                            </h4>
                            <p class="mb-0">Track your immigration journey and complete required actions below.</p>
                        </div>
                    </div>
                </div>

                <!-- Cases List -->
                <t t-if="cases">
                    <t t-foreach="cases" t-as="case">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-white">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h5 class="mb-0">
                                            <a t-attf-href="/my/immigration/case/#{case.id}">
                                                <t t-esc="case.name"/>
                                            </a>
                                            <span t-if="case.immigration_goal" 
                                                  t-attf-class="mm-goal-tag mm-goal-tag--#{case.immigration_goal} ms-2">
                                                <t t-if="case.immigration_goal == 'pr'">Permanent Residence</t>
                                                <t t-elif="case.immigration_goal == 'temporary'">Temporary</t>
                                                <t t-else="">Undecided</t>
                                            </span>
                                        </h5>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge bg-primary">
                                            <t t-esc="case.stage_id.name"/>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Mini Progress Tracker -->
                                <t t-set="total_stages" t-value="len(stages)"/>
                                <t t-set="current_position" t-value="0"/>
                                <t t-foreach="stages" t-as="stage">
                                    <t t-if="stage.id == case.stage_id.id">
                                        <t t-set="current_position" t-value="stage_index + 1"/>
                                    </t>
                                </t>
                                <t t-call="mm_portal.portal_progress_tracker"/>
                                
                                <!-- Current Stage Info -->
                                <div class="current-stage-info mt-4 p-3 bg-light rounded">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="text-primary mb-2">
                                                <i class="fa fa-info-circle me-2" aria-hidden="true"></i>
                                                Current Step: <t t-esc="case.stage_id.name"/>
                                            </h6>
                                            <!-- Special case: Q2 complete but roadmap not delivered yet -->
                                            <t t-if="case.state == 'assessment' and case.q2_state == 'completed'">
                                                <p class="mb-0 text-success">
                                                    <i class="fa fa-check-circle me-1" aria-hidden="true"></i>
                                                    <strong>Assessment Complete!</strong> Your consultant is preparing your Immigration Roadmap (3-5 business days).
                                                </p>
                                            </t>
                                            <t t-else="">
                                                <p class="mb-0 text-muted">
                                                    <t t-esc="case.stage_id.portal_description"/>
                                                </p>
                                            </t>
                                        </div>
                                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                                            <!-- Hide action button if Q2 is completed -->
                                            <t t-if="case.state == 'assessment' and case.q2_state == 'completed'">
                                                <span class="badge bg-info">
                                                    <i class="fa fa-hourglass-half me-1" aria-hidden="true"></i>
                                                    Awaiting Roadmap
                                                </span>
                                            </t>
                                            <t t-elif="case.stage_id.portal_action_url and case.stage_id.portal_action_text">
                                                <a t-attf-href="#{case.stage_id.portal_action_url}" 
                                                   class="btn btn-primary">
                                                    <t t-esc="case.stage_id.portal_action_text"/>
                                                    <i class="fa fa-arrow-right ms-2" aria-hidden="true"></i>
                                                </a>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-white">
                                <div class="row">
                                    <div class="col">
                                        <small class="text-muted">
                                            <i class="fa fa-calendar me-1" aria-hidden="true"></i>
                                            Created: <t t-esc="case.create_date" t-options="{'widget': 'date'}"/>
                                        </small>
                                    </div>
                                    <div class="col text-end">
                                        <a t-attf-href="/my/immigration/case/#{case.id}" class="btn btn-sm btn-outline-primary">
                                            View Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </t>
                <t t-else="">
                    <div class="alert alert-warning">
                        <h5 class="alert-heading">No Cases Found</h5>
                        <p class="mb-0">You don't have any immigration cases yet. Please contact us to get started.</p>
                        <t t-if="settings.get('portal_email')">
                            <hr/>
                            <p class="mb-0">
                                <i class="fa fa-envelope me-2" aria-hidden="true"></i>
                                <a t-attf-href="mailto:#{settings.get('portal_email')}">
                                    <t t-esc="settings.get('portal_email')"/>
                                </a>
                            </p>
                        </t>
                    </div>
                </t>
            </div>
        </t>
    </template>

    <!-- Case Detail Template -->
    <template id="portal_immigration_case" name="Immigration Case Detail">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <t t-call="portal.portal_searchbar">
                <t t-set="title" t-value="case.name"/>
            </t>

            <!-- Breadcrumbs -->
            <div class="row mb-3">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/my/immigration">Immigration Cases</a>
                            </li>
                            <li class="breadcrumb-item active" t-esc="case.name"/>
                        </ol>
                    </nav>
                </div>
            </div>

            <div class="immigration-case-detail">
                <!-- Case Header -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <div class="row align-items-center">
                            <div class="col">
                                <h4 class="mb-0">
                                    <i class="fa fa-folder-open me-2" aria-hidden="true"></i>
                                    <t t-esc="case.name"/>
                                </h4>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-light text-primary fs-6">
                                    <t t-esc="case.stage_id.name"/>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Full Progress Tracker -->
                        <h6 class="text-muted mb-3">Your Progress</h6>
                        <t t-call="mm_portal.portal_progress_tracker"/>
                    </div>
                </div>

                <!-- Current Action Card -->
                <div class="card mb-4 shadow-sm border-primary">
                    <div class="card-header bg-light">
                        <h5 class="mb-0 text-primary">
                            <i class="fa fa-tasks me-2" aria-hidden="true"></i>
                            What's Next?
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Special case: Q2 complete but roadmap not delivered yet -->
                        <t t-if="case.state == 'assessment' and case.q2_state == 'completed'">
                            <div class="alert alert-success mb-3">
                                <i class="fa fa-check-circle me-2" aria-hidden="true"></i>
                                <strong>Questionnaire Complete!</strong> Thank you for completing your detailed assessment.
                            </div>
                            <p class="lead">
                                Your consultant is now reviewing your responses and preparing your personalized 
                                Immigration Roadmap. This typically takes 3-5 business days.
                            </p>
                            <p class="text-muted">
                                <i class="fa fa-clock-o me-2" aria-hidden="true"></i>
                                You will receive an email notification when your roadmap is ready for review.
                            </p>
                        </t>
                        <!-- Special case: Client signed, awaiting consultant counter-signature -->
                        <t t-elif="case.state == 'quoted' and case.service_agreement_id and case.service_agreement_id.state == 'pending_consultant'">
                            <div class="alert alert-info mb-3">
                                <i class="fa fa-check-circle me-2" aria-hidden="true"></i>
                                <strong>Agreement Signed!</strong> Thank you for signing the service agreement.
                            </div>
                            <p class="lead">
                                Your service agreement is now awaiting counter-signature from your immigration consultant.
                            </p>
                            <p class="text-muted">
                                <i class="fa fa-clock-o me-2" aria-hidden="true"></i>
                                You will receive an email notification once the agreement is fully executed and ready for payment.
                            </p>
                            <span class="badge bg-info text-white">
                                <i class="fa fa-hourglass-half me-1" aria-hidden="true"></i>
                                Awaiting Consultant Signature
                            </span>
                        </t>
                        <!-- Default stage-based content -->
                        <t t-else="">
                            <p class="lead">
                                <t t-esc="case.stage_id.portal_description"/>
                            </p>
                            <t t-if="case.stage_id.portal_action_url and case.stage_id.portal_action_text">
                                <a t-attf-href="#{case.stage_id.portal_action_url}" 
                                   class="btn btn-lg btn-primary">
                                    <t t-esc="case.stage_id.portal_action_text"/>
                                    <i class="fa fa-arrow-right ms-2" aria-hidden="true"></i>
                                </a>
                            </t>
                        </t>
                        <t t-if="case.stage_id.requires_signature">
                            <span class="badge bg-warning text-dark ms-2">
                                <i class="fa fa-pencil me-1" aria-hidden="true"></i>
                                Signature Required
                            </span>
                        </t>
                        <t t-if="case.stage_id.requires_payment">
                            <span class="badge bg-info text-white ms-2">
                                <i class="fa fa-credit-card me-1" aria-hidden="true"></i>
                                Payment Required
                            </span>
                        </t>
                    </div>
                </div>

                <div class="row">
                    <!-- Case Information -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fa fa-info-circle me-2" aria-hidden="true"></i>
                                    Case Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-borderless">
                                    <tr>
                                        <th class="text-muted" style="width: 40%">Case Reference</th>
                                        <td><t t-esc="case.name"/></td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">Immigration Goal</th>
                                        <td>
                                            <t t-if="case.immigration_goal == 'pr'">Permanent Residence</t>
                                            <t t-elif="case.immigration_goal == 'temporary'">Temporary Residence</t>
                                            <t t-elif="case.immigration_goal == 'undecided'">Undecided</t>
                                            <t t-else="">Not specified</t>
                                        </td>
                                    </tr>
                                    <tr t-if="case.target_year">
                                        <th class="text-muted">Target Year</th>
                                        <td><t t-esc="case.target_year"/></td>
                                    </tr>
                                    <tr t-if="case.recommended_pathway">
                                        <th class="text-muted">Recommended Pathway</th>
                                        <td>
                                            <span class="badge bg-success">
                                                <t t-esc="dict(case._fields['recommended_pathway'].selection).get(case.recommended_pathway, '')"/>
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="text-muted">Created</th>
                                        <td><t t-esc="case.create_date" t-options="{'widget': 'datetime'}"/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fa fa-link me-2" aria-hidden="true"></i>
                                    Quick Links
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="list-group list-group-flush">
                                    <a t-attf-href="/my/immigration/case/#{case.id}/documents" 
                                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="fa fa-file-text me-2 text-primary" aria-hidden="true"></i>
                                            Documents
                                        </span>
                                        <i class="fa fa-chevron-right text-muted" aria-hidden="true"></i>
                                    </a>
                                    <a href="/my/immigration/questionnaire/pre" 
                                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="fa fa-clipboard me-2 text-primary" aria-hidden="true"></i>
                                            Questionnaires
                                        </span>
                                        <i class="fa fa-chevron-right text-muted" aria-hidden="true"></i>
                                    </a>
                                    <a href="/my/immigration/roadmap" 
                                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="fa fa-map me-2 text-primary" aria-hidden="true"></i>
                                            Immigration Roadmap
                                        </span>
                                        <i class="fa fa-chevron-right text-muted" aria-hidden="true"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Section -->
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fa fa-phone me-2" aria-hidden="true"></i>
                            Need Help?
                        </h5>
                    </div>
                    <div class="card-body">
                        <p>If you have questions about your case, please contact us:</p>
                        <div class="row">
                            <t t-if="settings.get('portal_email')">
                                <div class="col-md-4">
                                    <p>
                                        <i class="fa fa-envelope text-primary me-2" aria-hidden="true"></i>
                                        <a t-attf-href="mailto:#{settings.get('portal_email')}">
                                            <t t-esc="settings.get('portal_email')"/>
                                        </a>
                                    </p>
                                </div>
                            </t>
                            <t t-if="settings.get('portal_phone')">
                                <div class="col-md-4">
                                    <p>
                                        <i class="fa fa-phone text-primary me-2" aria-hidden="true"></i>
                                        <t t-esc="settings.get('portal_phone')"/>
                                    </p>
                                </div>
                            </t>
                            <t t-if="settings.get('portal_website')">
                                <div class="col-md-4">
                                    <p>
                                        <i class="fa fa-globe text-primary me-2" aria-hidden="true"></i>
                                        <a t-att-href="settings.get('portal_website')" target="_blank">
                                            <t t-esc="settings.get('portal_website')"/>
                                        </a>
                                    </p>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Documents Page Template -->
    <template id="portal_case_documents" name="Case Documents">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Documents</t>
            </t>

            <!-- Breadcrumbs -->
            <div class="row mb-3">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/my/immigration">Immigration Cases</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a t-attf-href="/my/immigration/case/#{case.id}">
                                    <t t-esc="case.name"/>
                                </a>
                            </li>
                            <li class="breadcrumb-item active">Documents</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fa fa-file-text me-2" aria-hidden="true"></i>
                        Case Documents
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle me-2" aria-hidden="true"></i>
                        Documents will appear here as they become available throughout your immigration process.
                    </div>
                    
                    <!-- Document Categories -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fa fa-file-signature text-primary me-2" aria-hidden="true"></i>
                                        Agreements
                                    </h6>
                                    <p class="card-text text-muted small">
                                        Service agreements and signed documents
                                    </p>
                                    <t t-if="signed_agreements">
                                        <ul class="list-unstyled mb-0">
                                            <t t-foreach="signed_agreements" t-as="doc">
                                                <li class="mb-2">
                                                    <a t-attf-href="/web/content?model=mm.esign.request&amp;id=#{doc.id}&amp;field=signed_document&amp;filename_field=signed_filename&amp;download=true"
                                                       class="btn btn-sm btn-outline-primary">
                                                        <i class="fa fa-download me-1" aria-hidden="true"></i>
                                                        <t t-esc="doc.signed_filename or 'Signed Document'"/>
                                                    </a>
                                                    <small class="text-muted d-block mt-1">
                                                        Signed: <t t-esc="doc.signed_date" t-options="{'widget': 'date'}"/>
                                                    </small>
                                                </li>
                                            </t>
                                        </ul>
                                    </t>
                                    <t t-else="">
                                        <span class="badge bg-secondary">No signed documents yet</span>
                                    </t>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fa fa-map text-primary me-2" aria-hidden="true"></i>
                                        Immigration Roadmap
                                    </h6>
                                    <p class="card-text text-muted small">
                                        Your personalized immigration strategy
                                    </p>
                                    <t t-if="case.roadmap_document">
                                        <a t-attf-href="/web/content?model=mm.immigration.case&amp;id=#{case.id}&amp;field=roadmap_document&amp;filename_field=roadmap_filename&amp;download=true"
                                           class="btn btn-sm btn-primary">
                                            <i class="fa fa-download me-1" aria-hidden="true"></i>
                                            Download
                                        </a>
                                    </t>
                                    <t t-else="">
                                        <span class="badge bg-secondary">Pending</span>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Placeholder Template for Future Features -->
    <template id="portal_placeholder" name="Feature Coming Soon">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card shadow-sm text-center py-5">
                        <div class="card-body">
                            <i class="fa fa-clock-o fa-5x text-muted mb-4" aria-hidden="true"></i>
                            <h3>Coming Soon</h3>
                            <p class="text-muted lead">
                                <t t-esc="message"/>
                            </p>
                            <a href="/my/immigration" class="btn btn-primary mt-3">
                                <i class="fa fa-arrow-left me-2" aria-hidden="true"></i>
                                Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>
