<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- ===================== -->
    <!-- Portal Roadmap Templates -->
    <!-- ===================== -->

    <!-- Portal Roadmap View Page -->
    <template id="portal_roadmap_view" name="Immigration Roadmap">
        <t t-call="portal.portal_layout">
            <t t-set="title">Immigration Roadmap</t>
            
            <div class="container py-4 mm-roadmap-view">
                <div class="row">
                    <div class="col-12">
                        <!-- Breadcrumb -->
                        <nav aria-label="breadcrumb" class="mb-4">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a href="/my/immigration">My Immigration</a>
                                </li>
                                <li class="breadcrumb-item active" aria-current="page">
                                    Immigration Roadmap
                                </li>
                            </ol>
                        </nav>
                        
                        <!-- Status Banner -->
                        <div t-if="roadmap.state == 'delivered'" 
                             class="alert alert-info mb-4" role="alert">
                            <h4 class="alert-heading">
                                <i class="fa fa-map-o me-2" title="Roadmap" role="img" aria-label="Roadmap"></i>
                                Your Immigration Roadmap is Ready!
                            </h4>
                            <p>
                                Please review your personalized immigration roadmap carefully. 
                                Once you have reviewed the document, please sign the acknowledgment 
                                to proceed to your consultation with your immigration consultant.
                            </p>
                        </div>
                        
                        <div t-if="roadmap.state == 'acknowledged'" 
                             class="alert alert-success mb-4" role="alert">
                            <h4 class="alert-heading">
                                <i class="fa fa-check-circle me-2" title="Acknowledged" role="img" aria-label="Acknowledged"></i>
                                Roadmap Acknowledged
                            </h4>
                            <p>
                                Thank you for acknowledging your immigration roadmap. 
                                You can now proceed to book your consultation.
                            </p>
                        </div>
                        
                        <!-- Roadmap Header -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h4 class="mb-0">
                                    <i class="fa fa-map me-2" title="Roadmap" role="img" aria-label="Roadmap"></i>
                                    Immigration Roadmap
                                </h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Prepared For:</strong> <t t-esc="roadmap.client_full_name"/></p>
                                        <p><strong>Case Reference:</strong> <t t-esc="roadmap.case_id.name"/></p>
                                        <p><strong>Document Date:</strong> <t t-esc="roadmap.document_date"/></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Version:</strong> <t t-esc="roadmap.version"/></p>
                                        <p><strong>Prepared By:</strong> <t t-esc="roadmap.consultant_id.name"/></p>
                                        <p t-if="roadmap.crs_total_score">
                                            <strong>CRS Score:</strong> 
                                            <span class="badge bg-info">
                                                <t t-esc="roadmap.crs_total_score"/>
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Executive Summary -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Executive Summary</h5>
                            </div>
                            <div class="card-body">
                                <t t-raw="roadmap.executive_summary or 'No executive summary available.'"/>
                            </div>
                        </div>
                        
                        <!-- CRS Assessment -->
                        <div class="card mb-4" t-if="roadmap.crs_calculation_id">
                            <div class="card-header">
                                <h5 class="mb-0">CRS &amp; FSW Assessment</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>CRS Score</h6>
                                        <div class="display-4 text-primary mb-2">
                                            <t t-esc="roadmap.crs_total_score"/>
                                        </div>
                                        <span t-attf-class="badge #{roadmap.crs_tier == 'high' and 'bg-success' or roadmap.crs_tier == 'competitive' and 'bg-success' or roadmap.crs_tier == 'medium' and 'bg-warning' or 'bg-danger'}">
                                            <t t-esc="dict(roadmap._fields['crs_tier'].related_field.selection).get(roadmap.crs_tier, '')"/>
                                        </span>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>FSW 67-Point Grid</h6>
                                        <div class="display-4 mb-2">
                                            <t t-esc="roadmap.fsw_total_points"/><span class="fs-5 text-muted">/100</span>
                                        </div>
                                        <span t-attf-class="badge #{roadmap.fsw_eligible and 'bg-success' or 'bg-danger'}">
                                            <t t-if="roadmap.fsw_eligible">Eligible (67+ points)</t>
                                            <t t-else="">Not Eligible (need 67)</t>
                                        </span>
                                    </div>
                                </div>
                                
                                <hr/>
                                
                                <div t-if="roadmap.fsw_analysis">
                                    <h6>FSW Analysis</h6>
                                    <t t-raw="roadmap.fsw_analysis"/>
                                </div>
                                
                                <div t-if="roadmap.crs_simulation_notes" class="mt-3">
                                    <h6>Score Improvement Analysis</h6>
                                    <t t-raw="roadmap.crs_simulation_notes"/>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recommended Strategy -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fa fa-compass me-2" title="Strategy" role="img" aria-label="Strategy"></i>
                                    Recommended Strategy
                                </h5>
                            </div>
                            <div class="card-body">
                                <h6>Primary Strategy</h6>
                                <p class="fw-bold text-primary fs-5">
                                    <t t-esc="dict(roadmap._fields['primary_strategy'].selection).get(roadmap.primary_strategy, 'Not specified')"/>
                                </p>
                                <t t-raw="roadmap.primary_strategy_rationale"/>
                                
                                <div t-if="roadmap.backup_strategy and roadmap.backup_strategy != 'none'" class="mt-4">
                                    <h6>Backup Strategy</h6>
                                    <p class="fw-bold">
                                        <t t-esc="dict(roadmap._fields['backup_strategy'].selection).get(roadmap.backup_strategy, '')"/>
                                    </p>
                                    <t t-raw="roadmap.backup_strategy_rationale"/>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PNP Opportunities -->
                        <div class="card mb-4" t-if="roadmap.pnp_opportunity_ids">
                            <div class="card-header">
                                <h5 class="mb-0">PNP Opportunities</h5>
                            </div>
                            <div class="card-body">
                                <t t-raw="roadmap.pnp_analysis"/>
                                
                                <table class="table table-striped mt-3">
                                    <thead>
                                        <tr>
                                            <th>Province</th>
                                            <th>Program</th>
                                            <th>Fit Rating</th>
                                            <th>Processing Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="roadmap.pnp_opportunity_ids" t-as="pnp">
                                            <tr>
                                                <td><t t-esc="pnp.province_id.name"/></td>
                                                <td><t t-esc="pnp.program_name"/></td>
                                                <td>
                                                    <span t-attf-class="badge #{int(pnp.fit_rating) >= 4 and 'bg-success' or int(pnp.fit_rating) == 3 and 'bg-warning' or 'bg-secondary'}">
                                                        <t t-esc="pnp.fit_rating_display"/>
                                                    </span>
                                                </td>
                                                <td>
                                                    <t t-if="pnp.estimated_processing_months">
                                                        ~<t t-esc="pnp.estimated_processing_months"/> months
                                                    </t>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Timeline -->
                        <div class="card mb-4" t-if="roadmap.milestone_ids">
                            <div class="card-header">
                                <h5 class="mb-0">Timeline</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Start Date:</strong> 
                                        <t t-esc="roadmap.timeline_start_date"/>
                                    </div>
                                    <div class="col-md-6" t-if="roadmap.estimated_pr_date">
                                        <strong>Estimated PR Date:</strong> 
                                        <span class="text-success fw-bold">
                                            <t t-esc="roadmap.estimated_pr_date"/>
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="timeline">
                                    <t t-foreach="roadmap.milestone_ids" t-as="milestone">
                                        <div class="timeline-item d-flex mb-3">
                                            <div class="timeline-marker me-3">
                                                <span t-attf-class="badge rounded-pill #{milestone.status == 'completed' and 'bg-success' or milestone.is_critical and 'bg-danger' or 'bg-primary'}">
                                                    <t t-esc="milestone.weeks_from_start"/>w
                                                </span>
                                            </div>
                                            <div class="timeline-content flex-grow-1">
                                                <h6 class="mb-1">
                                                    <t t-esc="milestone.name"/>
                                                    <small class="text-muted ms-2">
                                                        <t t-esc="milestone.target_date"/>
                                                    </small>
                                                </h6>
                                                <p class="text-muted mb-0 small">
                                                    <t t-esc="milestone.description"/>
                                                </p>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                                
                                <t t-raw="roadmap.timeline_notes"/>
                            </div>
                        </div>
                        
                        <!-- Next Steps -->
                        <div class="card mb-4" t-if="roadmap.next_steps">
                            <div class="card-header bg-warning">
                                <h5 class="mb-0">
                                    <i class="fa fa-tasks me-2" title="Next Steps" role="img" aria-label="Next Steps"></i>
                                    Next Steps
                                </h5>
                            </div>
                            <div class="card-body">
                                <t t-raw="roadmap.next_steps"/>
                                
                                <div t-if="roadmap.eca_guidance" class="mt-3">
                                    <h6>ECA Guidance</h6>
                                    <t t-raw="roadmap.eca_guidance"/>
                                </div>
                                
                                <div t-if="roadmap.language_guidance" class="mt-3">
                                    <h6>Language Test Guidance</h6>
                                    <t t-raw="roadmap.language_guidance"/>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Download PDF -->
                        <div class="card mb-4" t-if="roadmap.pdf_document">
                            <div class="card-body text-center">
                                <a t-attf-href="/web/content/mm.roadmap.document/#{roadmap.id}/pdf_document/#{roadmap.pdf_filename}?download=true"
                                   class="btn btn-primary btn-lg">
                                    <i class="fa fa-download me-2" title="Download" role="img" aria-label="Download"></i>
                                    Download Complete Roadmap (PDF)
                                </a>
                            </div>
                        </div>
                        
                        <!-- Acknowledgment Form -->
                        <div t-if="roadmap.state == 'delivered'" class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fa fa-pencil me-2" title="Sign" role="img" aria-label="Sign"></i>
                                    Acknowledge Roadmap
                                </h5>
                            </div>
                            <div class="card-body">
                                <p>
                                    By signing below, I acknowledge that I have reviewed and understood 
                                    my personalized Immigration Roadmap prepared by The Migration Monitor.
                                </p>
                                
                                <form action="/my/immigration/roadmap/acknowledge" method="post">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    <input type="hidden" name="roadmap_id" t-att-value="roadmap.id"/>
                                    
                                    <div class="mb-3">
                                        <label for="signature" class="form-label">Your Signature</label>
                                        <div id="signature-pad-container" class="border rounded p-2" style="background: #f8f9fa;">
                                            <canvas id="signature-pad" width="600" height="150" style="width: 100%; max-width: 600px;"></canvas>
                                        </div>
                                        <input type="hidden" name="signature" id="signature-data"/>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="clearSignature()">
                                            Clear Signature
                                        </button>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="confirm_review" required="required"/>
                                        <label class="form-check-label" for="confirm_review">
                                            I confirm that I have reviewed and understood the Immigration Roadmap
                                        </label>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success btn-lg" onclick="return submitSignature()">
                                        <i class="fa fa-check me-2" title="Acknowledge" role="img" aria-label="Acknowledge"></i>
                                        Acknowledge Roadmap
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Already Acknowledged -->
                        <div t-if="roadmap.state == 'acknowledged'" class="card mb-4">
                            <div class="card-body text-center">
                                <p class="text-success mb-3">
                                    <i class="fa fa-check-circle fa-3x" title="Acknowledged" role="img" aria-label="Acknowledged"></i>
                                </p>
                                <h5>Roadmap Acknowledged</h5>
                                <p>
                                    Acknowledged on: <t t-esc="roadmap.acknowledged_date"/>
                                </p>
                                
                                <a href="/my/immigration/book" class="btn btn-primary btn-lg mt-3">
                                    <i class="fa fa-calendar me-2" title="Book" role="img" aria-label="Book"></i>
                                    Book Consultation
                                </a>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- Signature Pad Script -->
            <script type="text/javascript">
                var canvas = document.getElementById('signature-pad');
                var signaturePad;
                
                if (canvas) {
                    signaturePad = new SignaturePad(canvas, {
                        backgroundColor: 'rgb(255, 255, 255)',
                        penColor: 'rgb(0, 0, 0)'
                    });
                }
                
                function clearSignature() {
                    if (signaturePad) {
                        signaturePad.clear();
                    }
                }
                
                function submitSignature() {
                    if (signaturePad &amp;&amp; !signaturePad.isEmpty()) {
                        var dataUrl = signaturePad.toDataURL('image/png');
                        document.getElementById('signature-data').value = dataUrl;
                        return true;
                    } else {
                        alert('Please provide your signature before submitting.');
                        return false;
                    }
                }
            </script>
        </t>
    </template>
    
    <!-- Portal Roadmap Not Ready -->
    <template id="portal_roadmap_not_ready" name="Roadmap Not Ready">
        <t t-call="portal.portal_layout">
            <t t-set="title">Immigration Roadmap</t>
            
            <div class="container py-4">
                <div class="row justify-content-center">
                    <div class="col-md-8 text-center">
                        <div class="card">
                            <div class="card-body py-5">
                                <i class="fa fa-clock-o fa-4x text-muted mb-4" title="Pending" role="img" aria-label="Pending"></i>
                                <h3>Your Roadmap is Being Prepared</h3>
                                <p class="text-muted">
                                    Our consultants are carefully reviewing your profile and preparing 
                                    your personalized immigration roadmap. This typically takes 3-5 business days 
                                    after completing your detailed assessment questionnaire.
                                </p>
                                <p>
                                    You will receive an email notification when your roadmap is ready for review.
                                </p>
                                <a href="/my/immigration" class="btn btn-primary mt-3">
                                    <i class="fa fa-arrow-left me-2" title="Back" role="img" aria-label="Back"></i>
                                    Back to Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
    

</odoo>
